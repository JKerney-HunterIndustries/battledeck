<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Battledeck</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css" /> -->
    <!-- <script src="main.js"></script> -->
    <style>
        body {
            background-color: black;
            color: white;
        }

        .hidden {
            display: none
        }

        img {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
            height: 100%;
        }

        h1 {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            height: 100%;
            width: 100%;
        }

        .centered {
            position: fixed;
            top: 50%;
            left: 50%;
            /* bring your own prefixes */
            transform: translate(-50%, -50%);
        }

        #end {
            display: inline-block;
            margin: 0 auto;
        }

        #infoBlock {
            text-align: center;
        }

        a, a:hover, a:active, a:visited {
            color: aqua
        }
    </style>
</head>

<body>
    <div id='infoBlock' class="centered">
        <h1>Hit spacebar to start</h1>
        <br/>
        <h1 id="end"><a href="/end">Shutdown</a></h1>
    </div>
    <img id="battle-image" src="./eatThisImage.jpg" alt="caturday" class="hidden">
    <script>
        function getNewXhr() {
            return new XMLHttpRequest();
        }

        function isSuccess(status) {
            return 199 < status && status < 300;
        }

        function isDone(readyState) {
            return readyState === XMLHttpRequest.DONE;
        }

        function noop() { }

        function readyStateHandler(xhr, callback) {
            return function () {
                var next = isDone(xhr.readyState) ? callback : noop;
                var error = isSuccess(xhr.status) ? null : new Error(`Explodee! ${xhr.status}`);

                next(error);
            };
        }

        function shuffle(callback) {
            const xhr = getNewXhr();
            xhr.open('get', '/shuffle');
            xhr.onreadystatechange = readyStateHandler(xhr, callback);
            xhr.send();
        }

        function getRandomName() {
            return `${Math.floor(Math.random() * 1000)}.jpg`;
        }

        function isNotRunning(intervalId) {
            return (intervalId === null);
        }

        let intervalId = null;
        document.addEventListener("keyup", function (event) {
            const battleImage = document.getElementById('battle-image');
            const h1 = document.getElementById('infoBlock');

            function rumble() {
                battleImage.setAttribute('class', '');
                h1.setAttribute('class', 'hidden');

                clearInterval(intervalId);
                battleImage.setAttribute('src', getRandomName());
                intervalId = setInterval(function () {
                    battleImage.setAttribute('src', getRandomName());
                }, 20000);
            }

            if (event.keyCode === 32) {
                if (isNotRunning(intervalId)) {
                    shuffle(function (error) {
                        rumble();
                    });
                } else {
                    rumble();
                }
            }
            else if (event.keyCode === 27) {
                clearInterval(intervalId);
                intervalId = null;
                battleImage.setAttribute('class', 'hidden');
                h1.setAttribute('class', 'centered');
            }
        });
    </script>
</body>

</html>